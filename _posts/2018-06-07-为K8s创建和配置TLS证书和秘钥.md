---
layout:     post
title:     【原创】为K8s创建和配置TLS证书和秘钥
subtitle:   Linux服务配置
date:       2018-06-07
author:     Bob
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - 云计算,K8s，集群部署
---
### 背景
在CentOS上部署了kuberentes集群，其中最开始又重要的一步就是创建TLS认证的，很多人在进行到这一步时都会遇到各种各样千奇百怪的问题，这一步是创建集群的基础，我们有必要详细了解一下其背后的流程，以及如何跳过这些坑更快的安装好证书。鉴于网上对证书安装的完整教程和脚本叙述比较少，所以周飞飞在这里写个博文，作为自己的学习笔记，也为告诉大家如何避坑。


##### 首先确保你已经安装好了k8s的集群，我是在以下的集群环境（一主二从）进行的，三个节点都是CentOS7：
![](https://ws3.sinaimg.cn/large/006tKfTcgy1fs47acgyd7j30me0euq3e.jpg)
![](https://ws2.sinaimg.cn/large/006tKfTcgy1fs476oqoyzj30wy0o00tk.jpg)

### CentOS 7下静态IP配置
我遇到的第一个坑就是配置静态IP，这里也花了不少时间来解决遇到的问题。因为默认情况下，三个节点的IP地址是会自动变化的，但在证书的一些脚本中都会要用到IP地址进行配置，所以我们第一步就是要设置三个节点的IP地址为静态IP。我们在配置时会用到IP、gateway、dns。

#### 第一步，如何查看当前节点IP、gateway、dns

IP:
```
ifconfig|grep inet
```
gateway:
```
[root@localhost ~]# netstat -rn
```
(以0.0.0.0开始的行的gateway是默认网关,如：
0.0.0.0         172.16.0.254    0.0.0.0           UG        0      0          0 eth0
，则172.16.0.254是gateway)

DNS:
```
[root@localhost ~]# cat /etc/resolv.conf
```
search                 localdomain   <br>
nameserver              172.16.0.250

#### 第二步，则是配置静态IP，直接可以在CentOS的图形化界面进行设置：
![](https://ws2.sinaimg.cn/large/006tKfTcgy1fs47lig711j30m60ay3yu.jpg)
然后进入点击右下角的小齿轮图标，进入设置

然后选择IPv4，进行设置，填写虚拟机的IP地址，以及子网掩码和DNS
![](https://ws2.sinaimg.cn/large/006tKfTcgy1fs47mkqj9wj30jj0c90t9.jpg)
然后点击右下角的apply应用即可

#### 修改配置文件

修改ifcfg-ensXX（后面的数字可能有所不同，但不影响，改对应的就行）

```
vi /etc/sysconfig/network-scripts/ifcfg-ens33
```
打开就是这样
![](https://ws2.sinaimg.cn/large/006tKfTcgy1fs47ownbp0j30id094dg9.jpg)
在最后面添加信息：
添加信息：（这里填写自己的虚拟机IP和DNS地址）

IPADDR0=192.168.236.132<br>
GATWAY0=192.168.236.0<br>
DNS1=Your centOS DNS<br>

然后千万要注意的是，这里敲黑板划重点啦！<br>
PEERDNS="no"，这里一定一定要改成"no"啊，不然你后面根本没有办法修改配置文件

你可以ping通8.8.8.8，但是你不能ping通网页的，一直会给你报错：
<br>

ping: www.baidu.com: Name or service not known

或者：

<br>

ping: www.baidu.com: Temporary failure in name resolution

<br>
都是因为DNS域名解析错误啊！！如果是连8.8.8.8都不能ping通，那么一定是IP地址就有问题

按我上面写的去修改IPv4，并在文件/etc/sysconfig/network-scripts/ifcfg-ens33中添加IP地址

如果是可以ping 8.8.8.8，但是不能ping www.baidu.com，那么一定是DNS解析出了问题

去修改/etc/resolv.conf文件，并且一定要在之前的文件中将PEERDNS的值改为"no"!!!

不然你重启完网络后会发现resolv.conf没有任何的改变！

#### 继续修改配置

```
vi /etc/resolv.conf
```
修改为：

```
generated by /usr/sbin/dhclient-script
#search localdomain
#nameserver DNS
nameserver 8.8.8.8
nameserver 114.114.114.114
```

#### 重启网络服务
<br>
```
service network restart
```

### 创建证书
<br>
前面做了那么多工作，都是为了创建TLS证书做准备，现在让我们正式开始创建证书吧！

首先要明确，我们需要创建哪些证书：
<br>
生成的 CA 证书和秘钥文件如下：<br>
ca-key.pem <br>
ca.pem <br>	
kubernetes-key.pem <br>
kubernetes.pem <br>
kube-proxy.pem<br>
kube-proxy-key.pem<br>
admin.pem<br>
admin-key.pem<br>
<br>
使用证书的组件如下：<br>
etcd：使用 ca.pem、kubernetes-key.pem、kubernetes.pem；<br>
kube-apiserver：使用 ca.pem、kubernetes-key.pem、kubernetes.pem；<br>
kubelet：使用 ca.pem；<br>
kube-proxy：使用 ca.pem、kube-proxy-key.pem、kube-proxy.pem；<br>
kubectl：使用 ca.pem、admin-key.pem、admin.pem；<br>
kube-controller-manager：使用 ca-key.pem、ca.pem<br>
<br>
注意：以下操作都在 master 节点即 172.26.209.135 这台主机上执行，证书只需要创建一次即可，以后在向集群中添加新节点时只要将 /etc/kubernetes/ 目录下的证书拷贝到新节点上即可。

### 安装CFSSL
<br>
#### 方式一：直接使用二进制源码包安装
```
wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
chmod +x cfssl_linux-amd64
mv cfssl_linux-amd64 /usr/local/bin/cfssl

wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
chmod +x cfssljson_linux-amd64
mv cfssljson_linux-amd64 /usr/local/bin/cfssljson

wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
chmod +x cfssl-certinfo_linux-amd64
mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo

export PATH=/usr/local/bin:$PATH
```

#### 方式二：使用go命令安装

```
$ go get -u github.com/cloudflare/cfssl/cmd/...
$ echo $GOPATH
/usr/local
$ls /usr/local/bin/cfssl*

cfssl cfssl-bundle cfssl-certinfo cfssljson cfssl-newkey cfssl-scan

```
在GOPATH/bin目录下得到以cfssl开头的几个命令。
注意：以下文章中出现的cat的文件名如果不存在需要手工创建。
并且以下证书的创建都是在root文件夹下进行创建（root/ssl）

#### 创建 CA (Certificate Authority)

##### 创建 CA 配置文件

```
mkdir /root/ssl
cd /root/ssl
cfssl print-defaults config > config.json
cfssl print-defaults csr > csr.json
# 根据config.json文件的格式创建如下的ca-config.json文件
# 过期时间设置成了 87600h
cat > ca-config.json <<EOF
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ],
        "expiry": "87600h"
      }
    }
  }
}
EOF
```

##### 创建 CA 证书签名请求
创建 ca-csr.json 文件，内容如下:

```
{
  "CN": "kubernetes",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ],
    "ca": {
       "expiry": "87600h"
    }
}
```

生成 CA 证书和私钥:

```
$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca
$ ls ca*
ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem
```

####创建Server证书

```
cat > server-csr.json <<EOF
{
    "CN": "kubernetes",
    "hosts": [
      "127.0.0.1",
      "172.16.209.135",      "172.16.209.136",      "172.16.209.137",
      "10.10.10.1",
      "kubernetes",
      "kubernetes.default",
      "kubernetes.default.svc",
      "kubernetes.default.svc.cluster",
      "kubernetes.default.svc.cluster.local"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "BeiJing",
            "ST": "BeiJing",
            "O": "k8s",
            "OU": "System"
        }
    ]
}
EOF
```

生成 server 证书和私钥:

```
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server
```
####创建ADMIN证书
创建 admin 证书签名请求文件 admin-csr.json：

```
{
  "CN": "admin",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
```

生成 server 证书和私钥:

```
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin
```

####创建 kube-proxy 证书
创建 kube-proxy 证书签名请求文件 kube-proxy-csr.json：

```
{
  "CN": "system:kube-proxy",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
```
生成 kube-proxy 客户端证书和私钥:

```
$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy
$ ls kube-proxy*
kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem
```
至此我的master节点上的需要的证书都安装好了，查询一下看看我们安装了哪些证书：

![](https://ws4.sinaimg.cn/large/006tNc79gy1fs541jkrfuj30yk09cwfj.jpg)

#### 分发证书
将生成的证书和秘钥文件（后缀名为.pem）拷贝到所有机器的 /etc/kubernetes/ssl 目录下备用；

```
mkdir -p /etc/kubernetes/ssl
cp *.pem /etc/kubernetes/ssl
```

至此，TLS证书创建工作就已经well done啦，可以开始创建etcd集群了！